<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard</title>
    <th:block th:replace="../fragments/user_header :: header"></th:block>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        main {
            flex: 1;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #dddddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        footer {
            background-color: #dddddd;
            padding: 10px;
            text-align: center;
        }

        img {
            width: 100px;
            height: 100px;
        }

        .form-section {
            margin-top: 20px;
        }

        #oldPassword, #newPassword {
            -webkit-text-security: circle;
        }

        button {
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
<main>
    <h1 th:text="#{Welcome_to_Employee_Dashboard}">Welcome to Employee Dashboard!</h1>

    <table id="accountTable">
        <tr>
            <th th:text="#{Image}">Image</th>
            <td>
                <img id="accountImage" src="#" alt="Image Preview" style="max-width: 200px; display: none;"/>
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="file" id="imgFile" name="imgFile" accept="image/*">
                    <button type="button" onclick="uploadImage()">Upload</button>
                </form>
            </td>
        </tr>
        <tr>
            <th>ID</th>
            <td id="accountId"></td>
        </tr>
        <tr>
            <th th:text="#{Code}">Code</th>
            <td id="accountCode"></td>
        </tr>
        <tr>
            <th th:text="#{Name}">Name</th>
            <td id="accountName"></td>
        </tr>
        <tr>
            <th th:text="#{Gender}">Gender</th>
            <td id="accountGender"></td>
        </tr>
        <tr>
            <th th:text="#{Birthday}">Birthday</th>
            <td id="accountBirthday"></td>
        </tr>
        <tr>
            <th th:text="#{Salary}">Salary</th>
            <td id="accountSalary"></td>
        </tr>
        <tr>
            <th th:text="#{Level}">Level</th>
            <td id="accountLevel"></td>
        </tr>
        <tr>
            <th th:text="#{Email}">Email</th>
            <td id="accountMail"></td>
        </tr>
        <tr>
            <th th:text="#{Phone_Number}">Phone Number</th>
            <td id="accountPhone"></td>
        </tr>
        <tr>
            <th th:text="#{Note}">Note</th>
            <td id="accountNote"></td>
        </tr>
    </table>

    <div class="form-section">
        <button onclick="openEditForm()" th:text="#{Edit_Account}">Edit Account</button>
    </div>

    <div class="form-section" id="editForm" style="display: none;">
        <h2 th:text="#{Edit_Account}">Edit Account</h2>
        <label for="oldPassword" th:text="#{Old_Password}">Old Password:</label>
        <input type="password" id="oldPassword"/><br>
        <label for="newPassword" th:text="#{New_Password}">New Password:</label>
        <input type="password" id="newPassword"/><br>
        <button onclick="updateAccount()" th:text="#{Save_Changes}">Save Changes</button>
    </div>
</main>

<th:block th:replace="../fragments/footer :: footer"></th:block>

<script>

    function openEditForm() {
        document.getElementById('editForm').style.display = "block"
    }

    async function updateAccount() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('No token found. Please login again.');
                return;
            }

            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;

            const requestBody = {
                oldPassword: oldPassword,
                newPassword: newPassword
            };

            const response = await fetch('/api/employee/test', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Failed to update account:', errorData);
                alert("Failed to update account. Error: " + errorData.message);
                return;
            }

            const data = await response.json();
            console.log('Account updated successfully:', data);
            alert("Account updated successfully!");
            fetchAccountData()

        } catch (error) {
            // Xử lý lỗi nếu có ngoại lệ xảy ra
            console.error("Error:", error);
            alert("An error occurred, please try again.");
        }
    }


    function fetchAccountData() {
        const token = localStorage.getItem('token');

        fetch(`/api/employee`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(account => {
                document.getElementById('accountId').textContent = account.id;
                document.getElementById('accountCode').textContent = account.code;
                document.getElementById('accountName').textContent = account.name;
                document.getElementById('accountGender').textContent = account.gender ? 'Male' : 'Female';

                const accountImage = document.getElementById('accountImage');
                if (account.imgPath) {
                    accountImage.src = account.imgPath;
                    accountImage.style.display = 'block';
                } else {
                    accountImage.style.display = 'none';
                }

                document.getElementById('accountBirthday').textContent = account.birthday;
                document.getElementById('accountSalary').textContent = account.salary;
                document.getElementById('accountLevel').textContent = account.level;
                document.getElementById('accountMail').textContent = account.mail;
                document.getElementById('accountPhone').textContent = account.phoneNumber;
                document.getElementById('accountNote').textContent = account.note;
            })
            .catch(error => console.error('Error fetching account:', error));
    }

    function uploadImage() {
        const fileInput = document.getElementById('imgFile');
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const token = localStorage.getItem('token');

        fetch('/api/employee/upload_img', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.imgPath) {
                    const accountImage = document.getElementById('accountImage');
                    accountImage.src = data.imgPath;
                    accountImage.style.display = 'block';
                    alert("Image uploaded successfully!");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Failed to upload image.");
            });
    }

    // Fetch account data when the page loads
    fetchAccountData();

    function checkEmployeeAccess() {
        const token = localStorage.getItem('token');

        if (!token) {
            window.location.href = '/login';
            return;
        }

        fetch('/api/public/authen_employee', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to authenticate as employee');
                }
                return response.json();
            })
            .then(isEmployee => {
                if (!isEmployee) {
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Access denied. Employee privileges required.');
                window.location.href = '/login';
            });
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/login';
    }

    checkEmployeeAccess();
</script>
</body>
</html>
