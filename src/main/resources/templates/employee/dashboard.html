<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard</title>
    <th:block th:replace="../fragments/user_header :: header"></th:block>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        main {
            flex: 1;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #dddddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        footer {
            background-color: #dddddd;
            padding: 10px;
            text-align: center;
        }

        img {
            width: 100px;
            height: 100px;
        }

        .form-section {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<main>
    <h1>Welcome to Employee Dashboard!</h1>

    <table id="accountTable">
        <tr>
            <th>Image</th>
            <td>
                <img id="accountImage" src="#" alt="Image Preview" style="max-width: 200px; display: none;"/>
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="file" id="imgFile" name="imgFile" accept="image/*">
                    <button type="button" onclick="uploadImage()">Upload</button>
                </form>
            </td>
        </tr>
        <tr>
            <th>ID</th>
            <td id="accountId"></td>
        </tr>
        <tr>
            <th>#{Code}</th>
            <td id="accountCode"></td>
        </tr>
        <tr>
            <th>#{Name}</th>
            <td id="accountName"></td>
        </tr>
        <tr>
            <th>#{Gender}</th>
            <td id="accountGender"></td>
        </tr>
        <tr>
            <th>#{Birthday}</th>
            <td id="accountBirthday"></td>
        </tr>
        <tr>
            <th th:text=''>#{Salary}</th>
            <td id="accountSalary"></td>
        </tr>
        <tr>
            <th th:text=''>#{Level}</th>
            <td id="accountLevel"></td>
        </tr>
        <tr>
            <th th:text=''>#{Email}</th>
            <td id="accountMail"></td>
        </tr>
        <tr>
            <th th:text=''>#{Phone_Number}</th>
            <td id="accountPhone"></td>
        </tr>
        <tr>
            <th th:text=''>#{Note}</th>
            <td id="accountNote"></td>
        </tr>
    </table>

    <div class="form-section">
        <button onclick="openEditForm()" th:text=''>#{Edit_Account}</button>
    </div>

    <div class="form-section" id="editForm" style="display: none;">
        <h2 th:text=''>#{Edit_Account}</h2>
        <label for="oldPassword" th:text=''>#{Old_Password}:</label>
        <input type="text" id="oldPassword"><br>
        <label for="newPassword" th:text=''>#{New_Password}:</label>
        <input type="text" id="newPassword"><br>
        <button onclick="updateAccount()">#{Save_Changes}</button>
    </div>
</main>

<th:block th:replace="../fragments/footer :: footer"></th:block>

<script>
    const accountId = 1;

    function openEditForm() {
        document.getElementById('editForm').style.display = "block"
    }

    async function updateAccount() {
        try {
            const token = localStorage.getItem('token');
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;

            const requestBody = {
                oldPassword: oldPassword,
                newPassword: newPassword
            };

            fetch('/api/employee/change_password', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                body: requestBody
            })
                .then(response => response.json())

                .catch(error => {
                    console.error('Error:', error);
                    alert("Failed to upload image.");
                });
        } catch (error) {
            console.error("Error:", error);
            alert("An error occurred, please try again.");
        }
    }


    function fetchAccountData() {
        const token = localStorage.getItem('token');

        fetch(`/api/employee`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(account => {
                document.getElementById('accountId').textContent = account.id;
                document.getElementById('accountCode').textContent = account.code;
                document.getElementById('accountName').textContent = account.name;
                document.getElementById('accountGender').textContent = account.gender ? 'Male' : 'Female';

                const accountImage = document.getElementById('accountImage');
                if (account.imgPath) {
                    accountImage.src = account.imgPath;
                    accountImage.style.display = 'block';
                } else {
                    accountImage.style.display = 'none';
                }

                document.getElementById('accountBirthday').textContent = account.birthday;
                document.getElementById('accountSalary').textContent = account.salary;
                document.getElementById('accountLevel').textContent = account.level;
                document.getElementById('accountMail').textContent = account.mail;
                document.getElementById('accountPhone').textContent = account.phoneNumber;
                document.getElementById('accountNote').textContent = account.note;
            })
            .catch(error => console.error('Error fetching account:', error));
    }

    function uploadImage() {
        const fileInput = document.getElementById('imgFile');
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const token = localStorage.getItem('token');

        fetch('/api/employee/upload_img', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.imgPath) {
                    const accountImage = document.getElementById('accountImage');
                    accountImage.src = data.imgPath;
                    accountImage.style.display = 'block';
                    alert("Image uploaded successfully!");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Failed to upload image.");
            });
    }

    // Fetch account data when the page loads
    fetchAccountData();

    function checkEmployeeAccess() {
        const token = localStorage.getItem('token');

        if (!token) {
            window.location.href = '/login';
            return;
        }

        fetch('/api/public/authen_employee', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to authenticate as admin');
                }
                return response.json();
            })
            .then(isAdmin => {
                if (!isAdmin) {
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Access denied. Admin privileges required.');
                window.location.href = '/login';
            });
    }

    function logout() {
        localStorage.removeItem("token");
        location.href = '/login';
    }

    checkEmployeeAccess();
</script>
</body>
</html>
